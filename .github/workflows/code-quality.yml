# .github/workflows/code-quality.yml
# Main code quality workflow for BoltDBG

name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ===========================================================================
  # Clang-Format Check
  # ===========================================================================
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        clang-format --version
    
    - name: Run clang-format check
      run: |
        find src include tests examples -name '*.cpp' -o -name '*.hpp' -o -name '*.h' -o -name '*.c' | \
        xargs clang-format --dry-run --Werror -style=file
    
    - name: Show formatting suggestions
      if: failure()
      run: |
        echo "❌ Code formatting issues detected!"
        echo "Run 'cmake --build build --target format' to fix formatting"
        echo ""
        echo "To see the differences, run:"
        echo "clang-format -style=file <file> | diff -u <file> -"

  # ===========================================================================
  # Clang-Tidy Check
  # ===========================================================================
  clang-tidy:
    name: Clang-Tidy Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          xorg-dev
        clang-tidy --version
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          build/_deps
          ~/.cache/pip
        key: ${{ runner.os }}-deps-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-deps-
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBOLTDBG_BUILD_TESTS=OFF \
          -DBOLTDBG_BUILD_EXAMPLES=OFF
    
    - name: Build project (needed for clang-tidy)
      run: cmake --build build --config ${{ env.BUILD_TYPE }} -j $(nproc)
    
    - name: Run clang-tidy
      run: cmake --build build --target tidy
      continue-on-error: true
    
    - name: Upload clang-tidy results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: clang-tidy-results
        path: build/clang-tidy-output.txt
        retention-days: 30

  # ===========================================================================
  # Combined Check (Fast)
  # ===========================================================================
  quick-check:
    name: Quick Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          xorg-dev
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
    
    - name: Run format check
      run: cmake --build build --target format-check
    
    - name: Build project
      run: cmake --build build -j $(nproc)
    
    - name: Run clang-tidy (src only - faster)
      run: cmake --build build --target tidy-src
      continue-on-error: true

  # ===========================================================================
  # Build and Test (Multiple Platforms)
  # ===========================================================================
  build-test:
    name: Build (${{ matrix.os }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Debug, Release]
        include:
          - os: ubuntu-latest
            cmake_flags: "-DBOLTDBG_ENABLE_ASAN=ON"
          - os: macos-latest
            cmake_flags: ""
          - os: windows-latest
            cmake_flags: ""
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          xorg-dev \
          clang-format \
          clang-tidy
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja llvm
        echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
    
    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake ninja llvm
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          build/_deps
          ~/.cache/pip
          ~/Library/Caches/Homebrew
          C:\Users\runneradmin\AppData\Local\Temp\chocolatey
        key: ${{ runner.os }}-${{ matrix.build_type }}-deps-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.build_type }}-deps-
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBOLTDBG_BUILD_TESTS=ON \
          -DBOLTDBG_BUILD_EXAMPLES=ON \
          ${{ matrix.cmake_flags }}
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
    
    - name: Run tests
      if: matrix.build_type == 'Debug'
      working-directory: build
      run: ctest -C ${{ matrix.build_type }} --output-on-failure
    
    - name: Upload build artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs-${{ matrix.os }}-${{ matrix.build_type }}
        path: |
          build/CMakeFiles/*.log
          build/Testing/Temporary/
        retention-days: 7

  # ===========================================================================
  # Static Analysis Summary
  # ===========================================================================
  analysis-summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [format-check, clang-tidy, quick-check]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "## Code Quality Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.format-check.result }}" == "success" ]; then
          echo "✅ Format check passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Format check failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.clang-tidy.result }}" == "success" ]; then
          echo "✅ Clang-tidy passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Clang-tidy found issues" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.quick-check.result }}" == "success" ]; then
          echo "✅ Quick check passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Quick check failed" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Fail if critical checks failed
      if: needs.format-check.result == 'failure'
      run: exit 1
