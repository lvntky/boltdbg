# .github/workflows/pr-check.yml
# Lightweight checks for Pull Requests

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, master, develop ]

# Cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Quick PR Validation
  # ===========================================================================
  pr-validation:
    name: PR Quick Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy cmake ninja-build
    
    - name: Get changed files
      id: changed-files
      run: |
        # Get changed C++ files
        git fetch origin ${{ github.base_ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | \
                       grep -E '\.(cpp|hpp|h|cc|cxx)$' || echo "")
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "Changed files:"
        echo "$CHANGED_FILES"
    
    - name: Check formatting on changed files
      if: steps.changed-files.outputs.files != ''
      run: |
        echo "${{ steps.changed-files.outputs.files }}" | \
        xargs clang-format --dry-run --Werror -style=file
    
    - name: Configure and build
      run: |
        cmake -B build -G Ninja -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        cmake --build build -j $(nproc)
    
    - name: Run clang-tidy on changed files
      if: steps.changed-files.outputs.files != ''
      run: |
        echo "${{ steps.changed-files.outputs.files }}" | \
        xargs -r clang-tidy -p build --config-file=.clang-tidy
      continue-on-error: true
    
    - name: Comment on PR
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '❌ Code quality checks failed. Please run `cmake --build build --target format` and fix any clang-tidy warnings.'
          })

  # ===========================================================================
  # PR Size Check
  # ===========================================================================
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check PR size
      run: |
        git fetch origin ${{ github.base_ref }}
        LINES_CHANGED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | \
                       grep -oP '\d+(?= insertion)' || echo 0)
        echo "Lines changed: $LINES_CHANGED"
        
        if [ "$LINES_CHANGED" -gt 1000 ]; then
          echo "⚠️ Warning: Large PR with $LINES_CHANGED lines changed"
          echo "Consider breaking this into smaller PRs"
        fi
    
    - name: Summary
      run: |
        echo "## PR Statistics" >> $GITHUB_STEP_SUMMARY
        git diff --stat origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build on Multiple Compilers
  # ===========================================================================
  compiler-matrix:
    name: Build (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - { cc: gcc-11, cxx: g++-11 }
          - { cc: gcc-12, cxx: g++-12 }
          - { cc: clang-14, cxx: clang++-14 }
          - { cc: clang-15, cxx: clang++-15 }
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ${{ matrix.compiler.cc }} \
          ${{ matrix.compiler.cxx }} \
          cmake ninja-build \
          libgl1-mesa-dev xorg-dev
    
    - name: Configure
      env:
        CC: ${{ matrix.compiler.cc }}
        CXX: ${{ matrix.compiler.cxx }}
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBOLTDBG_BUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build -j $(nproc)
    
    - name: Test
      working-directory: build
      run: ctest --output-on-failure
